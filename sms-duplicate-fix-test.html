<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🛡️ SMS 중복 발송 방지 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">🛡️ SMS 중복 발송 방지 테스트</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 테스트 패널 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">🧪 중복 발송 방지 테스트</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">테스트 주문 ID</label>
                        <input type="text" id="test-order-id" value="TEST-001" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">테스트 상태</label>
                        <select id="test-status" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="결제완료">결제완료</option>
                            <option value="포장준비">포장준비</option>
                            <option value="배송시작">배송시작</option>
                            <option value="배송완료">배송완료</option>
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="testStatusChangeSms()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium">
                            📱 상태 변경 SMS 발송 테스트
                        </button>
                        
                        <button onclick="testManualSms()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium">
                            ✉️ 수동 SMS 발송 테스트
                        </button>
                        
                        <button onclick="testDuplicatePrevention()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-medium">
                            🛡️ 중복 발송 방지 테스트
                        </button>
                    </div>
                </div>
                
                <div id="test-result" class="mt-4 p-3 rounded-lg hidden"></div>
            </div>
            
            <!-- SMS 발송 기록 -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">📋 SMS 발송 기록</h2>
                
                <div class="space-y-2 mb-4">
                    <button onclick="showSmsHistory()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium">
                        📊 발송 기록 조회
                    </button>
                    
                    <button onclick="clearSmsHistory()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium">
                        🧹 기록 초기화
                    </button>
                </div>
                
                <div id="sms-history" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- 사용법 안내 -->
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 class="font-semibold text-blue-800 mb-2">📋 테스트 사용법</h3>
            <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                <li><strong>상태 변경 SMS 테스트:</strong> 주문 상태 변경 시 자동 발송되는 SMS를 시뮬레이션</li>
                <li><strong>수동 SMS 테스트:</strong> 사용자가 직접 발송하는 SMS를 시뮬레이션</li>
                <li><strong>중복 발송 방지 테스트:</strong> 5초 간격으로 같은 상태 SMS를 연속 발송하여 중복 방지 확인</li>
                <li><strong>발송 기록 조회:</strong> localStorage에 저장된 SMS 발송 기록을 확인</li>
                <li><strong>기록 초기화:</strong> 모든 SMS 발송 기록을 삭제하여 테스트 초기화</li>
            </ol>
        </div>
        
        <!-- 중복 방지 규칙 안내 -->
        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <h3 class="font-semibold text-green-800 mb-2">🛡️ 중복 방지 규칙</h3>
            <ul class="text-sm text-green-700 list-disc list-inside space-y-1">
                <li><strong>상태 변경 SMS:</strong> 같은 주문의 같은 상태로 5분 이내 중복 발송 방지</li>
                <li><strong>수동 SMS:</strong> 같은 주문에 대해 1분 이내 중복 발송 방지</li>
                <li><strong>발송 기록:</strong> localStorage에 타임스탬프와 함께 저장</li>
                <li><strong>자동 정리:</strong> 오래된 기록은 자동으로 무효화</li>
            </ul>
        </div>
    </div>

    <script>
        // 테스트용 SMS 발송 함수 (실제 발송하지 않음)
        async function mockSendSmsViaSolapi(phoneNumber, message, orderId) {
            console.log('📱 Mock SMS 발송:', { phoneNumber, message, orderId });
            
            // 실제 솔라피 API 호출 대신 시뮬레이션
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            return { success: true, message: 'SMS가 성공적으로 발송되었습니다.' };
        }

        // 상태 변경 SMS 테스트
        async function testStatusChangeSms() {
            const orderId = document.getElementById('test-order-id').value;
            const newStatus = document.getElementById('test-status').value;
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
            resultDiv.innerHTML = '<div class="text-blue-700">🔄 상태 변경 SMS 발송 중...</div>';
            
            try {
                // 중복 발송 방지 로직 시뮬레이션
                const smsKey = `${orderId}_${newStatus}`;
                const lastSmsTime = localStorage.getItem(`sms_sent_${smsKey}`);
                const now = Date.now();
                
                if (lastSmsTime && (now - parseInt(lastSmsTime)) < 300000) {
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-orange-50 border border-orange-200';
                    resultDiv.innerHTML = `
                        <div class="text-orange-700">
                            🛡️ 중복 SMS 발송 방지!<br>
                            <small>마지막 발송: ${new Date(parseInt(lastSmsTime)).toLocaleString()}</small>
                        </div>
                    `;
                    return;
                }
                
                // Mock SMS 발송
                const result = await mockSendSmsViaSolapi('01012345678', `주문 ${orderId} 상태가 ${newStatus}로 변경되었습니다.`, orderId);
                
                if (result.success) {
                    localStorage.setItem(`sms_sent_${smsKey}`, now.toString());
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    resultDiv.innerHTML = `
                        <div class="text-green-700">
                            ✅ 상태 변경 SMS 발송 성공!<br>
                            <small>주문: ${orderId}, 상태: ${newStatus}</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                resultDiv.innerHTML = `<div class="text-red-700">❌ 오류: ${error.message}</div>`;
            }
        }

        // 수동 SMS 테스트
        async function testManualSms() {
            const orderId = document.getElementById('test-order-id').value;
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
            resultDiv.innerHTML = '<div class="text-blue-700">🔄 수동 SMS 발송 중...</div>';
            
            try {
                // 중복 발송 방지 로직 시뮬레이션
                const manualSmsKey = `manual_sms_${orderId}`;
                const lastManualSmsTime = localStorage.getItem(manualSmsKey);
                const now = Date.now();
                
                if (lastManualSmsTime && (now - parseInt(lastManualSmsTime)) < 60000) {
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-orange-50 border border-orange-200';
                    resultDiv.innerHTML = `
                        <div class="text-orange-700">
                            🛡️ 중복 SMS 발송 방지!<br>
                            <small>마지막 발송: ${new Date(parseInt(lastManualSmsTime)).toLocaleString()}</small>
                        </div>
                    `;
                    return;
                }
                
                // Mock SMS 발송
                const result = await mockSendSmsViaSolapi('01012345678', `주문 ${orderId}에 대한 수동 SMS입니다.`, orderId);
                
                if (result.success) {
                    localStorage.setItem(manualSmsKey, now.toString());
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    resultDiv.innerHTML = `
                        <div class="text-green-700">
                            ✅ 수동 SMS 발송 성공!<br>
                            <small>주문: ${orderId}</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                resultDiv.innerHTML = `<div class="text-red-700">❌ 오류: ${error.message}</div>`;
            }
        }

        // 중복 발송 방지 테스트
        async function testDuplicatePrevention() {
            const orderId = document.getElementById('test-order-id').value;
            const newStatus = document.getElementById('test-status').value;
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
            resultDiv.innerHTML = '<div class="text-blue-700">🔄 중복 발송 방지 테스트 중...</div>';
            
            let successCount = 0;
            let blockedCount = 0;
            
            // 3번 연속으로 같은 SMS 발송 시도
            for (let i = 1; i <= 3; i++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const smsKey = `${orderId}_${newStatus}`;
                const lastSmsTime = localStorage.getItem(`sms_sent_${smsKey}`);
                const now = Date.now();
                
                if (lastSmsTime && (now - parseInt(lastSmsTime)) < 300000) {
                    blockedCount++;
                    console.log(`🛡️ ${i}번째 시도: 중복 발송 방지됨`);
                } else {
                    successCount++;
                    localStorage.setItem(`sms_sent_${smsKey}`, now.toString());
                    console.log(`✅ ${i}번째 시도: SMS 발송 성공`);
                }
            }
            
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-purple-50 border border-purple-200';
            resultDiv.innerHTML = `
                <div class="text-purple-700">
                    🧪 중복 발송 방지 테스트 완료!<br>
                    <small>성공: ${successCount}회, 차단: ${blockedCount}회</small>
                </div>
            `;
        }

        // SMS 발송 기록 조회
        function showSmsHistory() {
            const historyDiv = document.getElementById('sms-history');
            const smsHistory = [];
            const now = Date.now();
            
            // localStorage에서 SMS 발송 기록 수집
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('sms_sent_') || key.startsWith('manual_sms_'))) {
                    const timestamp = parseInt(localStorage.getItem(key));
                    const timeDiff = now - timestamp;
                    const timeAgo = formatTimeAgo(timeDiff);
                    
                    smsHistory.push({
                        key: key,
                        timestamp: timestamp,
                        timeAgo: timeAgo,
                        isRecent: timeDiff < 300000
                    });
                }
            }
            
            smsHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (smsHistory.length === 0) {
                historyDiv.innerHTML = '<div class="text-gray-500 text-sm">발송 기록이 없습니다.</div>';
                return;
            }
            
            historyDiv.innerHTML = smsHistory.map(item => `
                <div class="p-2 border rounded ${item.isRecent ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}">
                    <div class="text-sm font-medium">${item.key}</div>
                    <div class="text-xs text-gray-600">${new Date(item.timestamp).toLocaleString()} (${item.timeAgo})</div>
                </div>
            `).join('');
        }

        // 시간 차이를 읽기 쉬운 형태로 변환
        function formatTimeAgo(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}일 전`;
            if (hours > 0) return `${hours}시간 전`;
            if (minutes > 0) return `${minutes}분 전`;
            return '방금 전';
        }

        // SMS 발송 기록 초기화
        function clearSmsHistory() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('sms_sent_') || key.startsWith('manual_sms_'))) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
            resultDiv.innerHTML = `
                <div class="text-green-700">
                    🧹 SMS 발송 기록 초기화 완료!<br>
                    <small>${keysToRemove.length}개 항목 삭제됨</small>
                </div>
            `;
            
            // 기록 목록도 새로고침
            showSmsHistory();
        }

        // 페이지 로드 시 기록 조회
        window.onload = function() {
            showSmsHistory();
        };
    </script>
</body>
</html>

