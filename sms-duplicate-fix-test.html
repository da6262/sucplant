<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›¡ï¸ SMS ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">ğŸ›¡ï¸ SMS ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- í…ŒìŠ¤íŠ¸ íŒ¨ë„ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">ğŸ§ª ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ID</label>
                        <input type="text" id="test-order-id" value="TEST-001" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">í…ŒìŠ¤íŠ¸ ìƒíƒœ</label>
                        <select id="test-status" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="ê²°ì œì™„ë£Œ">ê²°ì œì™„ë£Œ</option>
                            <option value="í¬ì¥ì¤€ë¹„">í¬ì¥ì¤€ë¹„</option>
                            <option value="ë°°ì†¡ì‹œì‘">ë°°ì†¡ì‹œì‘</option>
                            <option value="ë°°ì†¡ì™„ë£Œ">ë°°ì†¡ì™„ë£Œ</option>
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="testStatusChangeSms()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium">
                            ğŸ“± ìƒíƒœ ë³€ê²½ SMS ë°œì†¡ í…ŒìŠ¤íŠ¸
                        </button>
                        
                        <button onclick="testManualSms()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium">
                            âœ‰ï¸ ìˆ˜ë™ SMS ë°œì†¡ í…ŒìŠ¤íŠ¸
                        </button>
                        
                        <button onclick="testDuplicatePrevention()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-medium">
                            ğŸ›¡ï¸ ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸
                        </button>
                    </div>
                </div>
                
                <div id="test-result" class="mt-4 p-3 rounded-lg hidden"></div>
            </div>
            
            <!-- SMS ë°œì†¡ ê¸°ë¡ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">ğŸ“‹ SMS ë°œì†¡ ê¸°ë¡</h2>
                
                <div class="space-y-2 mb-4">
                    <button onclick="showSmsHistory()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium">
                        ğŸ“Š ë°œì†¡ ê¸°ë¡ ì¡°íšŒ
                    </button>
                    
                    <button onclick="clearSmsHistory()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium">
                        ğŸ§¹ ê¸°ë¡ ì´ˆê¸°í™”
                    </button>
                </div>
                
                <div id="sms-history" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- ì‚¬ìš©ë²• ì•ˆë‚´ -->
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 class="font-semibold text-blue-800 mb-2">ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‚¬ìš©ë²•</h3>
            <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                <li><strong>ìƒíƒœ ë³€ê²½ SMS í…ŒìŠ¤íŠ¸:</strong> ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì‹œ ìë™ ë°œì†¡ë˜ëŠ” SMSë¥¼ ì‹œë®¬ë ˆì´ì…˜</li>
                <li><strong>ìˆ˜ë™ SMS í…ŒìŠ¤íŠ¸:</strong> ì‚¬ìš©ìê°€ ì§ì ‘ ë°œì†¡í•˜ëŠ” SMSë¥¼ ì‹œë®¬ë ˆì´ì…˜</li>
                <li><strong>ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸:</strong> 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ê°™ì€ ìƒíƒœ SMSë¥¼ ì—°ì† ë°œì†¡í•˜ì—¬ ì¤‘ë³µ ë°©ì§€ í™•ì¸</li>
                <li><strong>ë°œì†¡ ê¸°ë¡ ì¡°íšŒ:</strong> localStorageì— ì €ì¥ëœ SMS ë°œì†¡ ê¸°ë¡ì„ í™•ì¸</li>
                <li><strong>ê¸°ë¡ ì´ˆê¸°í™”:</strong> ëª¨ë“  SMS ë°œì†¡ ê¸°ë¡ì„ ì‚­ì œí•˜ì—¬ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™”</li>
            </ol>
        </div>
        
        <!-- ì¤‘ë³µ ë°©ì§€ ê·œì¹™ ì•ˆë‚´ -->
        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <h3 class="font-semibold text-green-800 mb-2">ğŸ›¡ï¸ ì¤‘ë³µ ë°©ì§€ ê·œì¹™</h3>
            <ul class="text-sm text-green-700 list-disc list-inside space-y-1">
                <li><strong>ìƒíƒœ ë³€ê²½ SMS:</strong> ê°™ì€ ì£¼ë¬¸ì˜ ê°™ì€ ìƒíƒœë¡œ 5ë¶„ ì´ë‚´ ì¤‘ë³µ ë°œì†¡ ë°©ì§€</li>
                <li><strong>ìˆ˜ë™ SMS:</strong> ê°™ì€ ì£¼ë¬¸ì— ëŒ€í•´ 1ë¶„ ì´ë‚´ ì¤‘ë³µ ë°œì†¡ ë°©ì§€</li>
                <li><strong>ë°œì†¡ ê¸°ë¡:</strong> localStorageì— íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í•¨ê»˜ ì €ì¥</li>
                <li><strong>ìë™ ì •ë¦¬:</strong> ì˜¤ë˜ëœ ê¸°ë¡ì€ ìë™ìœ¼ë¡œ ë¬´íš¨í™”</li>
            </ul>
        </div>
    </div>

    <script>
        // í…ŒìŠ¤íŠ¸ìš© SMS ë°œì†¡ í•¨ìˆ˜ (ì‹¤ì œ ë°œì†¡í•˜ì§€ ì•ŠìŒ)
        async function mockSendSmsViaSolapi(phoneNumber, message, orderId) {
            console.log('ğŸ“± Mock SMS ë°œì†¡:', { phoneNumber, message, orderId });
            
            // ì‹¤ì œ ì†”ë¼í”¼ API í˜¸ì¶œ ëŒ€ì‹  ì‹œë®¬ë ˆì´ì…˜
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            return { success: true, message: 'SMSê°€ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.' };
        }

        // ìƒíƒœ ë³€ê²½ SMS í…ŒìŠ¤íŠ¸
        async function testStatusChangeSms() {
            const orderId = document.getElementById('test-order-id').value;
            const newStatus = document.getElementById('test-status').value;
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
            resultDiv.innerHTML = '<div class="text-blue-700">ğŸ”„ ìƒíƒœ ë³€ê²½ SMS ë°œì†¡ ì¤‘...</div>';
            
            try {
                // ì¤‘ë³µ ë°œì†¡ ë°©ì§€ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜
                const smsKey = `${orderId}_${newStatus}`;
                const lastSmsTime = localStorage.getItem(`sms_sent_${smsKey}`);
                const now = Date.now();
                
                if (lastSmsTime && (now - parseInt(lastSmsTime)) < 300000) {
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-orange-50 border border-orange-200';
                    resultDiv.innerHTML = `
                        <div class="text-orange-700">
                            ğŸ›¡ï¸ ì¤‘ë³µ SMS ë°œì†¡ ë°©ì§€!<br>
                            <small>ë§ˆì§€ë§‰ ë°œì†¡: ${new Date(parseInt(lastSmsTime)).toLocaleString()}</small>
                        </div>
                    `;
                    return;
                }
                
                // Mock SMS ë°œì†¡
                const result = await mockSendSmsViaSolapi('01012345678', `ì£¼ë¬¸ ${orderId} ìƒíƒœê°€ ${newStatus}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, orderId);
                
                if (result.success) {
                    localStorage.setItem(`sms_sent_${smsKey}`, now.toString());
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    resultDiv.innerHTML = `
                        <div class="text-green-700">
                            âœ… ìƒíƒœ ë³€ê²½ SMS ë°œì†¡ ì„±ê³µ!<br>
                            <small>ì£¼ë¬¸: ${orderId}, ìƒíƒœ: ${newStatus}</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                resultDiv.innerHTML = `<div class="text-red-700">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ìˆ˜ë™ SMS í…ŒìŠ¤íŠ¸
        async function testManualSms() {
            const orderId = document.getElementById('test-order-id').value;
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
            resultDiv.innerHTML = '<div class="text-blue-700">ğŸ”„ ìˆ˜ë™ SMS ë°œì†¡ ì¤‘...</div>';
            
            try {
                // ì¤‘ë³µ ë°œì†¡ ë°©ì§€ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜
                const manualSmsKey = `manual_sms_${orderId}`;
                const lastManualSmsTime = localStorage.getItem(manualSmsKey);
                const now = Date.now();
                
                if (lastManualSmsTime && (now - parseInt(lastManualSmsTime)) < 60000) {
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-orange-50 border border-orange-200';
                    resultDiv.innerHTML = `
                        <div class="text-orange-700">
                            ğŸ›¡ï¸ ì¤‘ë³µ SMS ë°œì†¡ ë°©ì§€!<br>
                            <small>ë§ˆì§€ë§‰ ë°œì†¡: ${new Date(parseInt(lastManualSmsTime)).toLocaleString()}</small>
                        </div>
                    `;
                    return;
                }
                
                // Mock SMS ë°œì†¡
                const result = await mockSendSmsViaSolapi('01012345678', `ì£¼ë¬¸ ${orderId}ì— ëŒ€í•œ ìˆ˜ë™ SMSì…ë‹ˆë‹¤.`, orderId);
                
                if (result.success) {
                    localStorage.setItem(manualSmsKey, now.toString());
                    resultDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    resultDiv.innerHTML = `
                        <div class="text-green-700">
                            âœ… ìˆ˜ë™ SMS ë°œì†¡ ì„±ê³µ!<br>
                            <small>ì£¼ë¬¸: ${orderId}</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                resultDiv.innerHTML = `<div class="text-red-700">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸
        async function testDuplicatePrevention() {
            const orderId = document.getElementById('test-order-id').value;
            const newStatus = document.getElementById('test-status').value;
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
            resultDiv.innerHTML = '<div class="text-blue-700">ğŸ”„ ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸ ì¤‘...</div>';
            
            let successCount = 0;
            let blockedCount = 0;
            
            // 3ë²ˆ ì—°ì†ìœ¼ë¡œ ê°™ì€ SMS ë°œì†¡ ì‹œë„
            for (let i = 1; i <= 3; i++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const smsKey = `${orderId}_${newStatus}`;
                const lastSmsTime = localStorage.getItem(`sms_sent_${smsKey}`);
                const now = Date.now();
                
                if (lastSmsTime && (now - parseInt(lastSmsTime)) < 300000) {
                    blockedCount++;
                    console.log(`ğŸ›¡ï¸ ${i}ë²ˆì§¸ ì‹œë„: ì¤‘ë³µ ë°œì†¡ ë°©ì§€ë¨`);
                } else {
                    successCount++;
                    localStorage.setItem(`sms_sent_${smsKey}`, now.toString());
                    console.log(`âœ… ${i}ë²ˆì§¸ ì‹œë„: SMS ë°œì†¡ ì„±ê³µ`);
                }
            }
            
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-purple-50 border border-purple-200';
            resultDiv.innerHTML = `
                <div class="text-purple-700">
                    ğŸ§ª ì¤‘ë³µ ë°œì†¡ ë°©ì§€ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!<br>
                    <small>ì„±ê³µ: ${successCount}íšŒ, ì°¨ë‹¨: ${blockedCount}íšŒ</small>
                </div>
            `;
        }

        // SMS ë°œì†¡ ê¸°ë¡ ì¡°íšŒ
        function showSmsHistory() {
            const historyDiv = document.getElementById('sms-history');
            const smsHistory = [];
            const now = Date.now();
            
            // localStorageì—ì„œ SMS ë°œì†¡ ê¸°ë¡ ìˆ˜ì§‘
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('sms_sent_') || key.startsWith('manual_sms_'))) {
                    const timestamp = parseInt(localStorage.getItem(key));
                    const timeDiff = now - timestamp;
                    const timeAgo = formatTimeAgo(timeDiff);
                    
                    smsHistory.push({
                        key: key,
                        timestamp: timestamp,
                        timeAgo: timeAgo,
                        isRecent: timeDiff < 300000
                    });
                }
            }
            
            smsHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (smsHistory.length === 0) {
                historyDiv.innerHTML = '<div class="text-gray-500 text-sm">ë°œì†¡ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            historyDiv.innerHTML = smsHistory.map(item => `
                <div class="p-2 border rounded ${item.isRecent ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}">
                    <div class="text-sm font-medium">${item.key}</div>
                    <div class="text-xs text-gray-600">${new Date(item.timestamp).toLocaleString()} (${item.timeAgo})</div>
                </div>
            `).join('');
        }

        // ì‹œê°„ ì°¨ì´ë¥¼ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ë³€í™˜
        function formatTimeAgo(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}ì¼ ì „`;
            if (hours > 0) return `${hours}ì‹œê°„ ì „`;
            if (minutes > 0) return `${minutes}ë¶„ ì „`;
            return 'ë°©ê¸ˆ ì „';
        }

        // SMS ë°œì†¡ ê¸°ë¡ ì´ˆê¸°í™”
        function clearSmsHistory() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('sms_sent_') || key.startsWith('manual_sms_'))) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            const resultDiv = document.getElementById('test-result');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
            resultDiv.innerHTML = `
                <div class="text-green-700">
                    ğŸ§¹ SMS ë°œì†¡ ê¸°ë¡ ì´ˆê¸°í™” ì™„ë£Œ!<br>
                    <small>${keysToRemove.length}ê°œ í•­ëª© ì‚­ì œë¨</small>
                </div>
            `;
            
            // ê¸°ë¡ ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨
            showSmsHistory();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë¡ ì¡°íšŒ
        window.onload = function() {
            showSmsHistory();
        };
    </script>
</body>
</html>

