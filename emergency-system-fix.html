<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚨 긴급 시스템 로딩 오류 해결 - 경산다육식물농장</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fix-button {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .fix-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .emergency-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .loading-dots {
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body class="bg-red-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 긴급 알림 헤더 -->
        <div class="bg-red-600 text-white p-6 rounded-xl shadow-lg mb-8 emergency-pulse">
            <div class="text-center">
                <div class="text-4xl mb-4">🚨</div>
                <h1 class="text-3xl font-bold mb-2">시스템 로딩 오류 감지!</h1>
                <p class="text-xl">경산다육식물농장 관리시스템 긴급 복구 중...</p>
            </div>
        </div>

        <!-- 즉시 해결 버튼들 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- 1단계: 캐시 강제 삭제 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-red-600 mb-4">🗑️ 1단계: 캐시 강제 삭제</h2>
                <p class="text-gray-600 mb-4">브라우저 캐시와 서비스워커를 완전히 삭제합니다.</p>
                <button onclick="forceClearCache()" 
                    class="fix-button w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg">
                    💥 캐시 강제 삭제 실행
                </button>
                <div id="cacheStatus" class="mt-3 text-sm"></div>
            </div>

            <!-- 2단계: 서비스워커 재등록 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-orange-600 mb-4">🔄 2단계: 서비스워커 재등록</h2>
                <p class="text-gray-600 mb-4">서비스워커를 완전히 제거하고 새로 등록합니다.</p>
                <button onclick="reregisterServiceWorker()" 
                    class="fix-button w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg">
                    🔧 서비스워커 재등록
                </button>
                <div id="swStatus" class="mt-3 text-sm"></div>
            </div>

            <!-- 3단계: 메인 시스템 강제 로드 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-blue-600 mb-4">⚡ 3단계: 메인 시스템 강제 로드</h2>
                <p class="text-gray-600 mb-4">메인 시스템을 강제로 다시 로드합니다.</p>
                <button onclick="forceReloadMainSystem()" 
                    class="fix-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                    🚀 메인 시스템 강제 로드
                </button>
                <div id="systemStatus" class="mt-3 text-sm"></div>
            </div>

            <!-- 4단계: 완전 복구 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-green-600 mb-4">✅ 4단계: 완전 복구</h2>
                <p class="text-gray-600 mb-4">모든 단계를 한 번에 실행하여 완전히 복구합니다.</p>
                <button onclick="completeRecovery()" 
                    class="fix-button w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                    🎯 완전 복구 실행
                </button>
                <div id="recoveryStatus" class="mt-3 text-sm"></div>
            </div>
        </div>

        <!-- 실시간 진행 상황 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">📊 실시간 진행 상황</h2>
            <div id="progressArea" class="space-y-3">
                <div class="text-gray-600">복구 단계를 선택하여 진행하세요.</div>
            </div>
        </div>

        <!-- 수동 해결 방법 -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
            <h2 class="text-xl font-bold text-yellow-800 mb-4">🔧 수동 해결 방법</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h3 class="font-bold text-yellow-700 mb-2">브라우저별 캐시 삭제:</h3>
                    <ul class="space-y-1 text-yellow-700">
                        <li>• Chrome: Ctrl+Shift+Delete</li>
                        <li>• Firefox: Ctrl+Shift+Delete</li>
                        <li>• Safari: Cmd+Option+E</li>
                        <li>• Edge: Ctrl+Shift+Delete</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-yellow-700 mb-2">개발자 도구 방법:</h3>
                    <ul class="space-y-1 text-yellow-700">
                        <li>• F12 → Application → Storage</li>
                        <li>• Clear site data 클릭</li>
                        <li>• Service Workers → Unregister</li>
                        <li>• 새로고침 (Ctrl+F5)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🚨 긴급 시스템 복구 도구 시작...');

        // 진행 상황 표시
        function showProgress(message, type = 'info') {
            const progressArea = document.getElementById('progressArea');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                'info': 'text-blue-600',
                'success': 'text-green-600',
                'warning': 'text-yellow-600',
                'error': 'text-red-600'
            };
            
            const icons = {
                'info': '🔄',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            };
            
            const progressItem = document.createElement('div');
            progressItem.className = `p-3 bg-gray-50 rounded-lg ${colors[type]}`;
            progressItem.innerHTML = `
                <div class="flex items-center">
                    <span class="text-lg mr-2">${icons[type]}</span>
                    <div>
                        <div class="font-medium">${message}</div>
                        <div class="text-xs text-gray-500">${timestamp}</div>
                    </div>
                </div>
            `;
            
            progressArea.appendChild(progressItem);
            progressArea.scrollTop = progressArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 1단계: 캐시 강제 삭제
        async function forceClearCache() {
            const statusDiv = document.getElementById('cacheStatus');
            statusDiv.innerHTML = '<div class="text-blue-600">🔄 캐시 삭제 중...</div>';
            
            showProgress('1단계: 캐시 강제 삭제 시작', 'info');
            
            try {
                // 모든 캐시 삭제
                const cacheNames = await caches.keys();
                showProgress(`발견된 캐시: ${cacheNames.length}개`, 'info');
                
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    showProgress(`캐시 삭제됨: ${cacheName}`, 'success');
                }
                
                // localStorage 및 sessionStorage 삭제
                localStorage.clear();
                sessionStorage.clear();
                showProgress('Storage 데이터 삭제 완료', 'success');
                
                // IndexedDB 삭제 시도
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            indexedDB.deleteDatabase(db.name);
                            showProgress(`IndexedDB 삭제: ${db.name}`, 'success');
                        }
                    } catch (e) {
                        showProgress('IndexedDB 삭제 시도 (일부 제한)', 'warning');
                    }
                }
                
                statusDiv.innerHTML = '<div class="text-green-600">✅ 캐시 삭제 완료!</div>';
                showProgress('1단계: 캐시 강제 삭제 완료!', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="text-red-600">❌ 오류: ${error.message}</div>`;
                showProgress(`캐시 삭제 오류: ${error.message}`, 'error');
            }
        }

        // 2단계: 서비스워커 재등록
        async function reregisterServiceWorker() {
            const statusDiv = document.getElementById('swStatus');
            statusDiv.innerHTML = '<div class="text-blue-600">🔄 서비스워커 재등록 중...</div>';
            
            showProgress('2단계: 서비스워커 재등록 시작', 'info');
            
            try {
                if ('serviceWorker' in navigator) {
                    // 기존 서비스워커 모두 해제
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    showProgress(`발견된 서비스워커: ${registrations.length}개`, 'info');
                    
                    for (const registration of registrations) {
                        await registration.unregister();
                        showProgress('기존 서비스워커 해제됨', 'success');
                    }
                    
                    // 잠시 대기
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // 새로운 서비스워커 등록
                    const newRegistration = await navigator.serviceWorker.register('sw.js', {
                        scope: './',
                        updateViaCache: 'none'
                    });
                    
                    showProgress('새 서비스워커 등록 완료', 'success');
                    statusDiv.innerHTML = '<div class="text-green-600">✅ 서비스워커 재등록 완료!</div>';
                    showProgress('2단계: 서비스워커 재등록 완료!', 'success');
                    
                } else {
                    statusDiv.innerHTML = '<div class="text-yellow-600">⚠️ 서비스워커 미지원 브라우저</div>';
                    showProgress('서비스워커 미지원 브라우저', 'warning');
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="text-red-600">❌ 오류: ${error.message}</div>`;
                showProgress(`서비스워커 재등록 오류: ${error.message}`, 'error');
            }
        }

        // 3단계: 메인 시스템 강제 로드
        async function forceReloadMainSystem() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="text-blue-600">🔄 메인 시스템 로드 중...</div>';
            
            showProgress('3단계: 메인 시스템 강제 로드 시작', 'info');
            
            try {
                // 현재 페이지에서 메인 시스템 스크립트 로드 시도
                const script = document.createElement('script');
                script.src = 'js/app.js?' + Date.now(); // 캐시 버스팅
                script.onload = () => {
                    showProgress('메인 스크립트 로드 성공', 'success');
                    
                    // OrderManagementSystem 초기화 시도
                    setTimeout(() => {
                        if (typeof OrderManagementSystem !== 'undefined') {
                            try {
                                window.orderSystem = new OrderManagementSystem();
                                showProgress('OrderManagementSystem 초기화 성공', 'success');
                                statusDiv.innerHTML = '<div class="text-green-600">✅ 메인 시스템 로드 완료!</div>';
                                showProgress('3단계: 메인 시스템 강제 로드 완료!', 'success');
                            } catch (error) {
                                showProgress(`시스템 초기화 오류: ${error.message}`, 'error');
                                statusDiv.innerHTML = `<div class="text-red-600">❌ 초기화 오류: ${error.message}</div>`;
                            }
                        } else {
                            showProgress('OrderManagementSystem 클래스를 찾을 수 없음', 'warning');
                            statusDiv.innerHTML = '<div class="text-yellow-600">⚠️ 시스템 클래스 미발견</div>';
                        }
                    }, 1000);
                };
                
                script.onerror = () => {
                    showProgress('메인 스크립트 로드 실패', 'error');
                    statusDiv.innerHTML = '<div class="text-red-600">❌ 스크립트 로드 실패</div>';
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="text-red-600">❌ 오류: ${error.message}</div>`;
                showProgress(`메인 시스템 로드 오류: ${error.message}`, 'error');
            }
        }

        // 4단계: 완전 복구
        async function completeRecovery() {
            const statusDiv = document.getElementById('recoveryStatus');
            statusDiv.innerHTML = '<div class="text-blue-600">🔄 완전 복구 진행 중...</div>';
            
            showProgress('🎯 완전 복구 시작! 모든 단계 실행', 'info');
            
            try {
                // 1단계: 캐시 삭제
                await forceClearCache();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 2단계: 서비스워커 재등록
                await reregisterServiceWorker();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 3단계: 메인 시스템 로드
                await forceReloadMainSystem();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 최종 검증
                showProgress('최종 시스템 상태 검증 중...', 'info');
                
                if (window.orderSystem && typeof window.orderSystem === 'object') {
                    showProgress('🎉 완전 복구 성공! 시스템이 정상 작동합니다.', 'success');
                    statusDiv.innerHTML = '<div class="text-green-600">🎉 완전 복구 성공!</div>';
                    
                    // 3초 후 메인 페이지로 이동
                    setTimeout(() => {
                        if (confirm('복구가 완료되었습니다! 메인 페이지로 이동하시겠습니까?')) {
                            window.location.href = 'index.html';
                        }
                    }, 3000);
                    
                } else {
                    showProgress('⚠️ 복구 완료, 하지만 수동 새로고침 필요', 'warning');
                    statusDiv.innerHTML = '<div class="text-yellow-600">⚠️ 수동 새로고침 필요</div>';
                    
                    setTimeout(() => {
                        if (confirm('복구가 완료되었습니다! 페이지를 새로고침하시겠습니까?')) {
                            window.location.reload(true);
                        }
                    }, 2000);
                }
                
            } catch (error) {
                showProgress(`완전 복구 오류: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="text-red-600">❌ 복구 오류: ${error.message}</div>`;
            }
        }

        // 페이지 로드 시 자동 진단
        window.addEventListener('load', function() {
            showProgress('🚨 긴급 복구 도구 준비 완료', 'info');
            showProgress('시스템 로딩 오류를 해결하기 위한 단계를 선택하세요', 'info');
            
            // 현재 상태 간단 체크
            setTimeout(() => {
                const hasServiceWorker = 'serviceWorker' in navigator;
                const hasCaches = 'caches' in window;
                const isOnline = navigator.onLine;
                
                showProgress(`환경 체크: SW=${hasServiceWorker}, Cache=${hasCaches}, Online=${isOnline}`, 'info');
                
                if (!isOnline) {
                    showProgress('⚠️ 오프라인 상태입니다. 네트워크 연결을 확인하세요.', 'warning');
                }
            }, 1000);
        });
    </script>
</body>
</html>