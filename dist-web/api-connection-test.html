<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 API 연결 상태 확인 - 경산다육식물농장</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-good { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-error { color: #ef4444; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .test-item {
            transition: all 0.3s ease;
        }
        .test-item:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🔍 API 연결 상태 확인</h1>
            <p class="text-gray-600">경산다육식물농장 관리시스템 - RESTful Table API 테스트</p>
            <div class="mt-4">
                <button onclick="runAllTests()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg mr-4">
                    🚀 전체 테스트 실행
                </button>
                <button onclick="location.href='index.html'" 
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                    🏠 메인으로
                </button>
            </div>
        </div>

        <!-- 연결 상태 요약 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">📊 연결 상태 요약</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold" id="successCount">-</div>
                    <div class="text-sm text-gray-600">성공</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold" id="warningCount">-</div>
                    <div class="text-sm text-gray-600">경고</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold" id="errorCount">-</div>
                    <div class="text-sm text-gray-600">오류</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold" id="responseTime">-</div>
                    <div class="text-sm text-gray-600">평균 응답시간(ms)</div>
                </div>
            </div>
        </div>

        <!-- API 테스트 결과 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">🧪 API 테스트 결과</h2>
            <div id="testResults" class="space-y-3">
                <!-- 테스트 결과가 여기 표시됩니다 -->
            </div>
        </div>

        <!-- 상세 로그 -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">📋 상세 로그</h2>
            <div id="detailLogs" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto">
                <div>🔍 API 연결 테스트 시작...</div>
            </div>
        </div>
    </div>

    <script>
        console.log('🔍 API 연결 상태 확인 도구 시작...');

        // 전역 변수
        let testResults = [];
        let successCount = 0;
        let warningCount = 0;
        let errorCount = 0;
        let totalResponseTime = 0;

        // 로그 추가 함수
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('detailLogs');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400'
            }[type] || 'text-gray-400';
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-1 ${colorClass}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 테스트 결과 표시
        function displayTestResult(testName, status, responseTime, details, error = null) {
            const resultDiv = document.getElementById('testResults');
            const testItem = document.createElement('div');
            testItem.className = 'test-item p-4 border border-gray-200 rounded-lg';
            
            const statusIcon = {
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            }[status];
            
            const statusClass = {
                'success': 'status-good',
                'warning': 'status-warning',
                'error': 'status-error'
            }[status];
            
            testItem.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-xl mr-3">${statusIcon}</span>
                        <div>
                            <h3 class="font-bold ${statusClass}">${testName}</h3>
                            <p class="text-sm text-gray-600">${details}</p>
                            ${error ? `<p class="text-sm text-red-600 mt-1">오류: ${error}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono text-sm ${statusClass}">${responseTime}ms</div>
                        <div class="text-xs text-gray-500">${status.toUpperCase()}</div>
                    </div>
                </div>
            `;
            
            resultDiv.appendChild(testItem);
            
            // 통계 업데이트
            if (status === 'success') successCount++;
            else if (status === 'warning') warningCount++;
            else if (status === 'error') errorCount++;
            
            totalResponseTime += responseTime;
            
            updateSummary();
        }

        // 요약 통계 업데이트
        function updateSummary() {
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('warningCount').textContent = warningCount;
            document.getElementById('errorCount').textContent = errorCount;
            
            const avgResponseTime = testResults.length > 0 ? 
                Math.round(totalResponseTime / testResults.length) : 0;
            document.getElementById('responseTime').textContent = avgResponseTime;
        }

        // API 테스트 함수들
        async function testApiEndpoint(tableName, method = 'GET', testData = null) {
            const startTime = Date.now();
            let url = `tables/${tableName}`;
            
            if (method === 'GET') {
                url += '?limit=1'; // 최소한의 데이터만 요청
            }
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (testData && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                options.body = JSON.stringify(testData);
            }
            
            try {
                addLog(`${method} ${url} 요청 시작...`);
                const response = await fetch(url, options);
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    const details = `상태: ${response.status}, 데이터: ${JSON.stringify(data).length}bytes`;
                    
                    addLog(`✅ ${method} ${url} 성공 (${responseTime}ms)`, 'success');
                    displayTestResult(
                        `${method} /${tableName}`, 
                        'success', 
                        responseTime, 
                        details
                    );
                    
                    return { success: true, data, responseTime };
                } else {
                    const errorText = await response.text();
                    const details = `HTTP ${response.status}: ${response.statusText}`;
                    
                    addLog(`❌ ${method} ${url} 실패: ${details}`, 'error');
                    displayTestResult(
                        `${method} /${tableName}`, 
                        'error', 
                        responseTime, 
                        details,
                        errorText
                    );
                    
                    return { success: false, error: errorText, responseTime };
                }
            } catch (error) {
                const responseTime = Date.now() - startTime;
                const details = '네트워크 오류 또는 CORS 문제';
                
                addLog(`❌ ${method} ${url} 네트워크 오류: ${error.message}`, 'error');
                displayTestResult(
                    `${method} /${tableName}`, 
                    'error', 
                    responseTime, 
                    details,
                    error.message
                );
                
                return { success: false, error: error.message, responseTime };
            }
        }

        // 테이블 존재 여부 확인
        async function testTableExists(tableName) {
            addLog(`📋 ${tableName} 테이블 존재 여부 확인...`);
            const result = await testApiEndpoint(tableName, 'GET');
            testResults.push(result);
            return result;
        }

        // 기본 CRUD 테스트
        async function testBasicCrud(tableName) {
            addLog(`🧪 ${tableName} 기본 CRUD 테스트 시작...`);
            
            // 1. READ 테스트
            await testTableExists(tableName);
            
            // 2. 테스트 데이터로 CREATE 시도 (실제로는 하지 않음)
            // 실제 데이터 생성은 위험하므로 스키마만 확인
        }

        // 전체 테스트 실행
        async function runAllTests() {
            addLog('🚀 전체 API 연결 테스트 시작...', 'info');
            
            // 통계 초기화
            successCount = 0;
            warningCount = 0;
            errorCount = 0;
            totalResponseTime = 0;
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            
            // 테스트할 테이블 목록
            const tables = [
                'products',
                'orders', 
                'order_items',
                'customers',
                'categories',
                'suppliers',
                'system_settings',
                'system_logs',
                'backup_history',
                'inventory_logs',
                'user_sessions',
                'order_sources',
                'waitlist'
            ];
            
            addLog(`📋 ${tables.length}개 테이블 연결 상태 확인 중...`);
            
            // 각 테이블 테스트
            for (const tableName of tables) {
                await testBasicCrud(tableName);
                
                // 테스트 간 간격
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // 추가 연결 테스트
            await testApiConnectivity();
            
            // 최종 결과
            addLog('✅ 전체 API 연결 테스트 완료!', 'success');
            
            // 결과 요약
            const totalTests = testResults.length;
            const successRate = totalTests > 0 ? ((successCount / totalTests) * 100).toFixed(1) : 0;
            
            addLog(`📊 테스트 결과: ${successCount}성공, ${warningCount}경고, ${errorCount}오류`, 'info');
            addLog(`📈 성공률: ${successRate}% (${successCount}/${totalTests})`, 'info');
            
            if (successRate >= 80) {
                addLog('🎉 API 연결 상태 양호!', 'success');
            } else if (successRate >= 50) {
                addLog('⚠️ API 연결 상태 주의 필요', 'warning');
            } else {
                addLog('❌ API 연결 상태 심각한 문제', 'error');
            }
        }

        // API 연결성 테스트
        async function testApiConnectivity() {
            addLog('🌐 API 서버 연결성 테스트...', 'info');
            
            // 1. Base URL 테스트
            try {
                const startTime = Date.now();
                const response = await fetch('tables/products?limit=1');
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    addLog('✅ API 서버 연결 성공', 'success');
                    displayTestResult(
                        'API 서버 연결', 
                        'success', 
                        responseTime, 
                        '서버 응답 정상'
                    );
                } else {
                    addLog(`⚠️ API 서버 응답 오류: ${response.status}`, 'warning');
                    displayTestResult(
                        'API 서버 연결', 
                        'warning', 
                        responseTime, 
                        `HTTP ${response.status} 응답`
                    );
                }
            } catch (error) {
                addLog(`❌ API 서버 연결 실패: ${error.message}`, 'error');
                displayTestResult(
                    'API 서버 연결', 
                    'error', 
                    0, 
                    '연결 불가',
                    error.message
                );
            }
            
            // 2. CORS 헤더 확인
            addLog('🔒 CORS 설정 확인...', 'info');
            
            // 3. 네트워크 상태 확인
            if (navigator.onLine) {
                addLog('🌐 네트워크 연결 상태: 온라인', 'success');
            } else {
                addLog('❌ 네트워크 연결 상태: 오프라인', 'error');
            }
        }

        // 페이지 로드 시 자동 실행
        window.addEventListener('load', function() {
            addLog('📄 페이지 로드 완료', 'info');
            addLog('💡 "전체 테스트 실행" 버튼을 클릭하여 API 상태를 확인하세요.', 'info');
        });

        // 네트워크 상태 모니터링
        window.addEventListener('online', () => {
            addLog('🌐 네트워크 연결 복구됨', 'success');
        });

        window.addEventListener('offline', () => {
            addLog('❌ 네트워크 연결 끊어짐', 'error');
        });
    </script>
</body>
</html>